<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart of Accounts | AndroGov</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brandRed: '#FB4747', 
                        brandDark: '#0F172A' 
                    },
                    fontFamily: { sans: ['Tajawal', 'Inter', 'sans-serif'], en: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        .num-font { font-family: 'Inter', sans-serif; }
        /* Tree Lines */
        .tree-line {
            position: absolute;
            right: 18px; /* For RTL */
            top: 36px;
            bottom: 0;
            width: 1px;
            background-color: #e2e8f0;
        }
        .dark .tree-line { background-color: #334155; }
        [dir="ltr"] .tree-line { right: auto; left: 18px; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300 opacity-0">

    <div id="sidebar-container"></div>
    
    <div class="main-content-wrapper md:mr-72 transition-all duration-300 flex flex-col min-h-screen">
        <div id="header-container"></div>

        <main class="p-6 space-y-6">
            
            <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 dark:text-white" data-i18n="pageTitle">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h1>
                    <p class="text-sm text-slate-500 mt-1" data-i18n="pageSub">Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø©</p>
                </div>
                <div class="flex gap-3">
                    <button class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-xs font-bold shadow-sm hover:bg-slate-50 transition flex items-center gap-2">
                        <i class="fa-solid fa-print text-slate-400"></i> <span data-i18n="btnPrint">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„</span>
                    </button>
                    <button onclick="openAccountModal()" class="px-4 py-2 bg-brandRed text-white rounded-lg text-xs font-bold shadow-lg shadow-red-500/30 hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-folder-plus"></i> <span data-i18n="btnAdd">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span>
                    </button>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px] relative">
                    <input type="text" id="searchInput" onkeyup="filterTree()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg pl-10 pr-4 py-2 text-xs focus:ring-1 focus:ring-brandRed outline-none dark:text-white" data-i18n-ph="searchPh">
                    <i class="fa-solid fa-search absolute top-2.5 left-3 text-slate-400"></i>
                </div>
                <div class="flex gap-2">
                    <button onclick="collapseAll()" class="px-3 py-1.5 text-xs bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition" data-i18n="btnCollapse">Ø·ÙŠ Ø§Ù„ÙƒÙ„</button>
                    <button onclick="expandAll()" class="px-3 py-1.5 text-xs bg-slate-100 dark:bg-slate-700 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition" data-i18n="btnExpand">ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒÙ„</button>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 min-h-[500px]">
                <div id="coa-tree" class="space-y-2">
                    </div>
            </div>

        </main>
    </div>

    <div id="accountModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900 rounded-t-2xl">
                <h3 class="font-bold text-lg dark:text-white" data-i18n="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form onsubmit="event.preventDefault(); alert('Account Created'); closeModal();" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lblParent">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                    <select class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs dark:text-white">
                        <option value="11">11 - Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©</option>
                        <option value="12">12 - Ø§Ù„Ø£ØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©</option>
                        <option value="21">21 - Ø§Ù„Ø®ØµÙˆÙ… Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lblCode">Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <input type="text" placeholder="110x" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs dark:text-white">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lblName">Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                        <input type="text" placeholder="..." class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs dark:text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lblType">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                    <select class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs dark:text-white">
                        <option data-i18n="typeDebit">Ù…Ø¯ÙŠÙ† (Debit)</option>
                        <option data-i18n="typeCredit">Ø¯Ø§Ø¦Ù† (Credit)</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="isTrans" class="rounded text-brandRed focus:ring-brandRed">
                    <label for="isTrans" class="text-xs text-slate-600 dark:text-slate-300 font-bold" data-i18n="chkTrans">ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚ÙŠÙˆØ¯ (Transactional)</label>
                </div>
                
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border border-slate-200 dark:border-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 dark:text-white" data-i18n="btnCancel">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="px-6 py-2 bg-brandRed text-white rounded-lg text-xs font-bold hover:bg-red-700 shadow-md" data-i18n="btnSave">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <script src="data/company_policy.js"></script>
    <script src="js/core/i18n.js"></script>
    <script src="js/components/layout.js"></script>
    <script src="js/components/bot.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø­Ø±Ùƒ v10.5
        const ctoUser = {
            id: 'USR_002',
            name: 'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø®ÙŠØªÙŠ ',
            displayName: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ',
            role: 'CFO', // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø­Ø« Ø¹Ù†Ù‡ Ø§Ù„Ù…Ø­Ø±Ùƒ Ù„ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            avatar: 'https://ui-avatars.com/api/?name=Meshail+AlHadyan&background=FB4747&color=fff'
        };
        
        // 2. ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù€ LocalStorage Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø­Ø±Ùƒ
        localStorage.setItem('currentUser', JSON.stringify(ctoUser));
        localStorage.setItem('activeRole', 'cto');

        // 3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ù…ÙØ¶Ù„
        if (!localStorage.getItem('theme')) {
            localStorage.setItem('theme', 'light');
        }

        // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ
        if (typeof Layout !== 'undefined') {
            Layout.init();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ø£Ù† Ø§Ù„Ù€ body Ù„Ù‡ opacity-0)
            document.body.style.opacity = '1';
            console.log("ğŸš€ CFO Layout Engine v10.5 Started Successfully");
        } else {
            console.error("âŒ Layout.js file not found! Check your script paths.");
        }
    });
</script>


    <script>
        // --- COA Data Structure ---
        const coaData = [
            {
                code: "1", nameAr: "Ø§Ù„Ø£ØµÙˆÙ„", nameEn: "Assets", type: "dr", balance: 2850000, children: [
                    {
                        code: "11", nameAr: "Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Current Assets", type: "dr", balance: 2450000, children: [
                            { code: "1101", nameAr: "Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆÙƒ", nameEn: "Cash at Bank", type: "dr", balance: 2050000, isLeaf: true },
                            { code: "1102", nameAr: "Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©", nameEn: "Petty Cash", type: "dr", balance: 15000, isLeaf: true },
                            { code: "1103", nameAr: "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø°Ù…Ù… Ù…Ø¯ÙŠÙ†Ø©)", nameEn: "Accounts Receivable", type: "dr", balance: 385000, isLeaf: true }
                        ]
                    },
                    {
                        code: "12", nameAr: "Ø§Ù„Ø£ØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Non-Current Assets", type: "dr", balance: 400000, children: [
                            { code: "1201", nameAr: "Ø£Ø¬Ù‡Ø²Ø© ÙˆÙ…Ø¹Ø¯Ø§Øª", nameEn: "Equipment", type: "dr", balance: 250000, isLeaf: true },
                            { code: "1202", nameAr: "Ø£Ø«Ø§Ø« ÙˆÙ…ÙØ±ÙˆØ´Ø§Øª", nameEn: "Furniture", type: "dr", balance: 150000, isLeaf: true }
                        ]
                    }
                ]
            },
            {
                code: "2", nameAr: "Ø§Ù„Ø®ØµÙˆÙ…", nameEn: "Liabilities", type: "cr", balance: 450000, children: [
                    {
                        code: "21", nameAr: "Ø§Ù„Ø®ØµÙˆÙ… Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©", nameEn: "Current Liabilities", type: "cr", balance: 450000, children: [
                            { code: "2101", nameAr: "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", nameEn: "Accounts Payable", type: "cr", balance: 125000, isLeaf: true },
                            { code: "2102", nameAr: "Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³ØªØ­Ù‚Ø©", nameEn: "Accrued Expenses", type: "cr", balance: 25000, isLeaf: true },
                            { code: "2103", nameAr: "Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©", nameEn: "VAT Payable", type: "cr", balance: 300000, isLeaf: true }
                        ]
                    }
                ]
            },
            {
                code: "3", nameAr: "Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©", nameEn: "Equity", type: "cr", balance: 6000000, children: [
                    { code: "3101", nameAr: "Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„", nameEn: "Share Capital", type: "cr", balance: 6000000, isLeaf: true }
                ]
            },
            {
                code: "4", nameAr: "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", nameEn: "Revenue", type: "cr", balance: 1500000, children: [
                    { code: "4101", nameAr: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹", nameEn: "Projects Revenue", type: "cr", balance: 1200000, isLeaf: true },
                    { code: "4102", nameAr: "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰", nameEn: "Other Income", type: "cr", balance: 300000, isLeaf: true }
                ]
            },
            {
                code: "5", nameAr: "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", nameEn: "Expenses", type: "dr", balance: 400000, children: [
                    { code: "5101", nameAr: "Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ø£Ø¬ÙˆØ±", nameEn: "Salaries & Wages", type: "dr", balance: 320000, isLeaf: true },
                    { code: "5102", nameAr: "Ù…ØµØ§Ø±ÙŠÙ Ø¥Ø¯Ø§Ø±ÙŠØ©", nameEn: "Admin Expenses", type: "dr", balance: 50000, isLeaf: true },
                    { code: "5103", nameAr: "Ù…ØµØ§Ø±ÙŠÙ ØªØ³ÙˆÙŠÙ‚", nameEn: "Marketing Expenses", type: "dr", balance: 30000, isLeaf: true }
                ]
            }
        ];

        // --- Translations ---
        const translations = {
            ar: {
                pageTitle: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", pageSub: "Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø©",
                btnPrint: "Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„", btnAdd: "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", searchPh: "Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...",
                btnCollapse: "Ø·ÙŠ Ø§Ù„ÙƒÙ„", btnExpand: "ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒÙ„",
                modalTitle: "Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", lblParent: "Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ", lblCode: "Ø±Ù…Ø² Ø§Ù„Ø­Ø³Ø§Ø¨", lblName: "Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨",
                lblType: "Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨", typeDebit: "Ù…Ø¯ÙŠÙ† (Debit)", typeCredit: "Ø¯Ø§Ø¦Ù† (Credit)", chkTrans: "ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚ÙŠÙˆØ¯ (Transactional)",
                btnCancel: "Ø¥Ù„ØºØ§Ø¡", btnSave: "Ø­ÙØ¸"
            },
            en: {
                pageTitle: "Chart of Accounts", pageSub: "Organizational structure of financial accounts",
                btnPrint: "Print COA", btnAdd: "New Account", searchPh: "Search Account Name or Code...",
                btnCollapse: "Collapse All", btnExpand: "Expand All",
                modalTitle: "Add New Account", lblParent: "Parent Account", lblCode: "Account Code", lblName: "Account Name",
                lblType: "Account Type", typeDebit: "Debit", typeCredit: "Credit", chkTrans: "Allow Transactions",
                btnCancel: "Cancel", btnSave: "Save"
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            applyLanguage();
            renderTree(coaData, document.getElementById('coa-tree'));
            window.addEventListener('storage', (e) => { if (e.key === 'lang') location.reload(); });
        });

        function applyLanguage() {
            const lang = localStorage.getItem('lang') || 'ar';
            const dict = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) el.innerText = dict[key];
            });
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (dict[key]) el.placeholder = dict[key];
            });
        }

        // --- Tree Rendering Logic ---
        function renderTree(nodes, container, level = 0) {
            const lang = localStorage.getItem('lang') || 'ar';
            
            nodes.forEach(node => {
                const hasChildren = node.children && node.children.length > 0;
                
                // Color coding for root items
                let iconColor = "text-slate-400";
                if(level === 0) {
                    if(node.code.startsWith('1')) iconColor = "text-green-600"; // Assets
                    if(node.code.startsWith('2')) iconColor = "text-red-500"; // Liabilities
                    if(node.code.startsWith('3')) iconColor = "text-blue-600"; // Equity
                    if(node.code.startsWith('4')) iconColor = "text-green-700"; // Revenue
                    if(node.code.startsWith('5')) iconColor = "text-orange-500"; // Expense
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = `relative ${level > 0 ? 'pr-6 rtl:pr-6 ltr:pl-6' : ''}`; // Indentation

                const contentHtml = `
                    <div class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 bg-white dark:bg-slate-800 transition group tree-node" data-code="${node.code}" data-name="${lang==='ar'?node.nameAr:node.nameEn}">
                        <div class="flex items-center gap-3">
                            ${hasChildren 
                                ? `<button onclick="toggleNode(this)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition text-slate-500"><i class="fa-solid fa-chevron-down text-xs transition-transform"></i></button>`
                                : `<span class="w-6 h-6"></span>`
                            }
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-xs font-bold ${iconColor} bg-slate-50 dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600">${node.code}</span>
                                <span class="font-bold text-sm text-slate-800 dark:text-white">${lang==='ar'?node.nameAr:node.nameEn}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <span class="text-xs font-bold num-font ${node.type==='dr'?'text-slate-600 dark:text-slate-300':'text-slate-600 dark:text-slate-300'}">${node.balance.toLocaleString()} SAR</span>
                            <div class="opacity-0 group-hover:opacity-100 transition flex gap-2">
                                <button class="text-slate-400 hover:text-brandRed" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                                ${!hasChildren ? `<button class="text-slate-400 hover:text-brandRed" title="History"><i class="fa-solid fa-list"></i></button>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                itemDiv.innerHTML = contentHtml;
                
                // Add Children Container
                if (hasChildren) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = "mt-1 space-y-1 relative";
                    // Add vertical line
                    const line = document.createElement('div');
                    line.className = "tree-line";
                    childrenDiv.appendChild(line);
                    
                    renderTree(node.children, childrenDiv, level + 1);
                    itemDiv.appendChild(childrenDiv);
                }

                container.appendChild(itemDiv);
            });
        }

        window.toggleNode = function(btn) {
            const childrenContainer = btn.closest('.relative').querySelector('div.mt-1');
            const icon = btn.querySelector('i');
            
            if (childrenContainer.classList.contains('hidden')) {
                childrenContainer.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
            } else {
                childrenContainer.classList.add('hidden');
                icon.style.transform = 'rotate(90deg)'; // Rotate for collapsed (LTR/RTL dependent usually, simplfied here)
                if(document.dir === 'rtl') icon.style.transform = 'rotate(90deg)';
                else icon.style.transform = 'rotate(-90deg)';
            }
        };

        window.collapseAll = function() {
            document.querySelectorAll('#coa-tree div.mt-1').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.fa-chevron-down').forEach(el => {
                el.style.transform = document.dir === 'rtl' ? 'rotate(90deg)' : 'rotate(-90deg)';
            });
        };

        window.expandAll = function() {
            document.querySelectorAll('#coa-tree div.mt-1').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('.fa-chevron-down').forEach(el => el.style.transform = 'rotate(0deg)');
        };

        window.filterTree = function() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            const nodes = document.querySelectorAll('.tree-node');
            
            if(!val) {
                // Reset visibility
                nodes.forEach(n => {
                    n.parentElement.style.display = 'block';
                });
                return;
            }

            nodes.forEach(n => {
                const name = n.getAttribute('data-name').toLowerCase();
                const code = n.getAttribute('data-code');
                const match = name.includes(val) || code.includes(val);
                
                if(match) {
                    n.parentElement.style.display = 'block';
                    // Ensure parents are visible
                    let parent = n.parentElement.parentElement; // div.mt-1
                    while(parent && parent.id !== 'coa-tree') {
                        parent.classList.remove('hidden');
                        parent.parentElement.style.display = 'block';
                        parent = parent.parentElement.parentElement;
                    }
                } else {
                    n.parentElement.style.display = 'none';
                }
            });
        };

        // Modal
        window.openAccountModal = () => document.getElementById('accountModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('accountModal').classList.add('hidden');

    </script>
</body>
</html>
