<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبة النماذج | eGov System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">

    <style>
        /* --- تنسيقات الفلتر والشبكة --- */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 12px; cursor: pointer; white-space: nowrap; transition: 0.3s; font-weight: bold; font-size: 13px; }
        .filter-btn:hover, .filter-btn.active { background: var(--lavender-dark); color: #fff; border-color: var(--lavender-dark); }

        .forms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .form-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; transition: 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .form-card:hover { transform: translateY(-5px); border-color: var(--secondary-color); box-shadow: var(--shadow-md); }
        
        /* شريط ملون علوي */
        .form-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--border-color); }
        .cat-HR::before { background: var(--lavender-light); }
        .cat-Finance::before { background: var(--mint-green); }
        .cat-Legal::before { background: var(--soft-orange); }
        .cat-IT::before { background: var(--sky-blue); }

        .form-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; background: var(--bg-elevated); color: var(--text-primary); }
        .form-title { font-size: 15px; font-weight: bold; color: var(--text-primary); margin-bottom: 5px; min-height: 40px; display: flex; align-items: center; }
        .form-meta { font-size: 11px; color: var(--text-secondary); margin-bottom: 20px; display: flex; justify-content: space-between; }
        
        .form-actions { margin-top: auto; display: flex; gap: 10px; }
        .btn-action { flex: 1; background: var(--bg-elevated); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px; border-radius: 8px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn-action:hover { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .btn-fill { background: var(--bg-primary); border-color: var(--secondary-color); color: var(--secondary-color); }
        .btn-fill:hover { background: var(--secondary-color); color: #fff; }

        .search-container { position: relative; margin-bottom: 25px; }
        .search-input { width: 100%; padding: 15px 45px 15px 15px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); outline: none; }
        .search-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-secondary); }

        /* --- نافذة عرض النموذج (The Form Viewer) --- */
        .viewer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .viewer-box { background: #fff; width: 800px; max-width: 95%; height: 90vh; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; color: #000; }
        
        .viewer-header { padding: 15px 20px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; color: #1f2937; }
        .viewer-body { flex: 1; padding: 40px; overflow-y: auto; background: #fff; font-family: 'Times New Roman', serif; line-height: 1.8; font-size: 16px; white-space: pre-wrap; }
        
        /* تنسيق الحقول الديناميكية داخل النموذج */
        .dynamic-input { border: none; border-bottom: 1px dashed #000; background: #f9f9f9; padding: 2px 5px; font-family: inherit; font-size: inherit; color: #000; min-width: 150px; outline: none; transition: 0.2s; }
        .dynamic-input:focus { background: #eef2ff; border-bottom: 1px solid var(--primary-color); }
        
        /* تنسيق الطباعة */
        @media print {
            body * { visibility: hidden; }
            .viewer-overlay, .viewer-box, .viewer-body, .viewer-body * { visibility: visible; }
            .viewer-overlay { position: absolute; left: 0; top: 0; background: #fff; }
            .viewer-box { width: 100%; height: auto; box-shadow: none; border: none; }
            .viewer-header { display: none; } /* إخفاء أزرار التحكم عند الطباعة */
            .viewer-body { padding: 0; overflow: visible; }
            .dynamic-input { border-bottom: none; background: transparent; } /* إخفاء حدود الحقول عند الطباعة لتبدو كأنها مطبوعة */
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="Layout.toggleSidebar()"></div>

    <div id="formViewer" class="viewer-overlay">
        <div class="viewer-box">
            <div class="viewer-header">
                <h3 style="margin:0; font-family: 'Tajawal', sans-serif;" id="viewerTitle">عنوان النموذج</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="printForm()" style="background: #1f2937; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-family: 'Tajawal', sans-serif;">
                        <i class="fas fa-print"></i> طباعة / PDF
                    </button>
                    <button onclick="closeViewer()" style="background: #e5e7eb; color: #374151; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-family: 'Tajawal', sans-serif;">
                        <i class="fas fa-times"></i> إغلاق
                    </button>
                </div>
            </div>
            <div class="viewer-body" id="viewerContent">
                </div>
        </div>
    </div>

    <div class="app-container">
        <aside id="appSidebar" class="sidebar"></aside>
        <div class="main-content">
            <header id="appTopbar" class="topbar"></header>

            <main class="dashboard-content fade-in" id="workspace">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; color: var(--text-primary);" data-i18n="forms_title">مكتبة النماذج الرقمية</h2>
                        <p style="margin: 5px 0 0; color: var(--text-secondary); font-size: 13px;" data-i18n="forms_desc">تحميل وتعبئة النماذج الرسمية المعتمدة.</p>
                    </div>
                </div>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="formSearch" class="search-input" placeholder="..." data-i18n="ph_search_forms" onkeyup="renderForms()">
                </div>

                <div class="filter-bar" id="categoryFilters">
                    <button class="filter-btn active" onclick="filterCategory(this, 'All')" data-i18n="cat_all">الكل</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'hr')" data-i18n="cat_hr">الموارد البشرية</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'finance')" data-i18n="cat_finance">المالية</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'governance')" data-i18n="cat_legal">الحوكمة والقانونية</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'it')" data-i18n="cat_it">التقنية</button>
                </div>

                <div class="forms-grid" id="formsGrid">
                    </div>

            </main>
        </div>
    </div>

    <script src="../assets/js/core/i18n.js"></script>
    <script src="../assets/js/layout.js"></script>
    <script src="../assets/js/components/bot.js"></script>
    
    <script src="../assets/js/data/forms_templates.js"></script> 
    
    <script src="../assets/js/system.js"></script>

    <script>
        // --- 1. الترجمات ---
        const pageTranslations = {
            ar: {
                forms_title: "مكتبة النماذج الرقمية", forms_desc: "تعبئة وطباعة النماذج الرسمية.",
                ph_search_forms: "ابحث عن اسم النموذج...",
                cat_all: "الكل", cat_hr: "الموارد البشرية", cat_finance: "المالية", cat_legal: "الحوكمة", cat_it: "التقنية",
                btn_fill: "تعبئة النموذج", btn_print: "طباعة فارغ"
            },
            en: {
                forms_title: "Forms Library", forms_desc: "Fill and print official forms.",
                ph_search_forms: "Search forms...",
                cat_all: "All", cat_hr: "HR", cat_finance: "Finance", cat_legal: "Governance", cat_it: "IT",
                btn_fill: "Fill Form", btn_print: "Print Blank"
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            if(window.SYSTEM_TRANSLATIONS) {
                Object.assign(window.SYSTEM_TRANSLATIONS.ar, pageTranslations.ar);
                Object.assign(window.SYSTEM_TRANSLATIONS.en, pageTranslations.en);
                const lang = localStorage.getItem('eGov_Lang') || 'ar';
                if(window.updateLanguage) window.updateLanguage(lang);
            }
            loadFormsData();
        });

        // --- 2. منطق العرض ---
        let currentFilter = 'All';
        let allFormsList = [];

        function loadFormsData() {
            // التعامل مع اسم المتغير سواء كان حروف صغيرة أو كبيرة
            const data = window.egovformstemplates || window.egovFormsTemplates;
            
            if (data && data.forms) {
                allFormsList = data.forms;
                renderForms();
            } else {
                document.getElementById('formsGrid').innerHTML = '<p style="color:red; text-align:center; grid-column:1/-1;">خطأ: لم يتم العثور على ملف البيانات (forms_templates.js)</p>';
            }
        }

        function filterCategory(btn, cat) {
            currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderForms();
        }

        function renderForms() {
            const grid = document.getElementById('formsGrid');
            const search = document.getElementById('formSearch').value.toLowerCase();
            const lang = localStorage.getItem('eGov_Lang') || 'ar';
            
            grid.innerHTML = '';

            const filtered = allFormsList.filter(item => {
                // تصفية حسب القسم
                let itemCat = item.category.toLowerCase();
                // توحيد المسميات للفلتر
                if (itemCat === 'board' || itemCat === 'admin' || itemCat === 'procurement') {
                    if (currentFilter === 'governance' && (itemCat === 'board' || itemCat === 'admin')) return true;
                    if (currentFilter === 'finance' && itemCat === 'procurement') return true;
                }
                
                const matchesCat = currentFilter === 'All' || itemCat === currentFilter.toLowerCase();
                
                // تصفية حسب البحث
                const title = lang === 'ar' ? item.name.ar : item.name.en;
                const matchesSearch = title.toLowerCase().includes(search);
                
                return matchesCat && matchesSearch;
            });

            if(filtered.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color:#666; grid-column:1/-1;">لا توجد نماذج</p>';
                return;
            }

            filtered.forEach(item => {
                const title = lang === 'ar' ? item.name.ar : item.name.en;
                const catDisplay = item.category.toUpperCase();
                
                // تحديد الأيقونة واللون
                let iconClass = 'fa-file-alt';
                let colorClass = 'cat-IT';
                
                if (item.category === 'hr') { iconClass = 'fa-users'; colorClass = 'cat-HR'; }
                else if (item.category === 'finance') { iconClass = 'fa-coins'; colorClass = 'cat-Finance'; }
                else if (item.category === 'governance') { iconClass = 'fa-balance-scale'; colorClass = 'cat-Legal'; }
                else if (item.category === 'board') { iconClass = 'fa-gavel'; colorClass = 'cat-Legal'; }

                const card = document.createElement('div');
                card.className = `form-card ${colorClass}`;
                card.innerHTML = `
                    <div class="form-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="form-title" title="${title}">${title}</div>
                    <div class="form-meta">
                        <span><i class="far fa-folder"></i> ${catDisplay}</span>
                        <span>Official</span>
                    </div>
                    <div class="form-actions">
                        <button class="btn-action" onclick="alert('سيتم تنزيل النسخة الفارغة')">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn-action btn-fill" onclick="openFormViewer('${item.id}')">
                            <i class="fas fa-pen"></i> <span data-i18n="btn_fill">${lang === 'ar' ? 'تعبئة' : 'Fill'}</span>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 3. المنطق السحري (تحويل النص إلى حقول) ---
        function openFormViewer(formId) {
            const data = window.egovformstemplates || window.egovFormsTemplates;
            const form = data.forms.find(f => f.id === formId);
            if(!form) return;

            const lang = localStorage.getItem('eGov_Lang') || 'ar';
            const title = lang === 'ar' ? form.name.ar : form.name.en;
            let content = lang === 'ar' ? form.templates.ar : form.templates.en;

            // السحر هنا: استبدال المتغيرات {{variable}} بحقول إدخال
            // Regex يبحث عن أي شيء بين قوسين معقوفين مزدوجين
            content = content.replace(/{{(.*?)}}/g, (match, p1) => {
                // p1 هو اسم المتغير (مثل employee_name)
                // نحاول إيجاد الاسم العربي له من الحقول
                let placeholder = p1;
                const fieldDef = form.fields.find(f => f.name === p1);
                if (fieldDef) {
                    placeholder = lang === 'ar' ? fieldDef.label.ar : fieldDef.label.en;
                }
                // إرجاع حقل إدخال HTML
                return `<input type="text" class="dynamic-input" placeholder="${placeholder}" />`;
            });

            document.getElementById('viewerTitle').innerText = title;
            document.getElementById('viewerContent').innerHTML = content;
            document.getElementById('formViewer').style.display = 'flex';
        }

        function closeViewer() {
            document.getElementById('formViewer').style.display = 'none';
        }

        function printForm() {
            window.print();
        }
    </script>

</body>
</html>
