<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FB4747">
    <meta name="description" content="AndroGov - User & Role Management System">
    <title>AndroGov | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://ait.sa/wp-content/uploads/2024/03/cropped-Square-Logo.png" type="image/png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brandRed: '#FB4747',
                        brandBlue: '#4267B2',
                        brandDark: '#1E293B',
                        brandGray: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'Inter', 'sans-serif'],
                        en: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        /* âœ… Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { 
            background: #CBD5E1; 
            border-radius: 10px; 
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #475569; }
        .dark .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748B; }
        
        /* âœ… Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .dark .loading-overlay {
            background: rgba(15, 23, 42, 0.9);
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(66, 103, 178, 0.1);
            border-top-color: #4267B2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* âœ… Fade In Animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* âœ… Smooth Transitions */
        * {
            transition-property: background-color, border-color, color, fill, stroke, margin, padding;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        
        /* âœ… Main Content Wrapper Transition */
        .main-content-wrapper {
            transition: margin-left 300ms ease, margin-right 300ms ease;
        }
        
        /* âœ… Sidebar Transition */
        #main-sidebar {
            transition: left 300ms ease, right 300ms ease, transform 300ms ease;
        }
    </style>
</head>

<body class="bg-brandGray dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans">

    <!-- âœ… Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-brandRed/20 border-t-brandRed rounded-full animate-spin"></div>
            <div class="absolute inset-0 w-16 h-16 border-4 border-transparent border-b-brandBlue rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 0.8s;"></div>
        </div>
        <p class="text-sm font-bold text-slate-600 dark:text-slate-300 animate-pulse" data-i18n="users.loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- âœ… Sidebar Container -->
    <div id="sidebar-container" class="no-print"></div>
    
    <!-- âœ… Main Content Wrapper -->
    <div class="main-content-wrapper md:mr-72 transition-all duration-300 flex flex-col min-h-screen">
        
        <!-- âœ… Header Container -->
        <div id="header-container" class="no-print"></div>

        <!-- Page Content -->
        <main class="p-6 space-y-6">
            
            <!-- Page Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-800 dark:text-white mb-1" data-i18n="users.pageTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h1>
                    <p class="text-sm text-slate-500 dark:text-slate-400" data-i18n="users.pageDesc">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø¨Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø± (RBAC)</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="stats-container">
                <!-- Loading Placeholders -->
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 animate-pulse">
                    <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mb-3"></div>
                    <div class="h-8 bg-slate-200 dark:bg-slate-700 rounded w-1/3"></div>
                </div>
            </div>

            <!-- Main Workspace -->
            <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 min-h-[600px] flex flex-col overflow-hidden">
                
                <!-- Toolbar -->
                <div class="p-4 md:p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col md:flex-row justify-between items-stretch md:items-center gap-4">
                    
                    <!-- View Tabs -->
                    <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                        <button 
                            onclick="UsersPage.switchView('users')" 
                            id="btn-users" 
                            class="flex-1 md:flex-none px-4 md:px-6 py-2 text-xs font-bold rounded-lg bg-white dark:bg-slate-600 text-brandBlue shadow-sm transition-all flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-users"></i>
                            <span data-i18n="users.directory">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                        </button>
                        <button 
                            onclick="UsersPage.switchView('roles')" 
                            id="btn-roles" 
                            class="flex-1 md:flex-none px-4 md:px-6 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 transition-all flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-shield-halved"></i>
                            <span data-i18n="users.rolesStructure">Ù‡ÙŠÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                        </button>
                    </div>
                    
                    <!-- Search (Users View Only) -->
                    <div class="flex gap-3" id="userToolbar">
                        <div class="relative flex-1 md:w-72">
                            <input 
                                type="text" 
                                id="searchInput" 
                                onkeyup="UsersPage.search(this.value)"
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm focus:ring-2 focus:ring-brandBlue focus:border-transparent outline-none dark:text-white transition-all"
                                data-i18n-placeholder="users.searchPlaceholder"
                                placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¯ÙˆØ±ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..."
                            >
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <!-- View: Users List -->
                <div id="view-users" class="flex-1 fade-in">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-700/50 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase sticky top-0">
                                <tr>
                                    <th class="p-4 text-right" data-i18n="users.colUser">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th class="p-4 text-right" data-i18n="users.colRole">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                    <th class="p-4 text-right" data-i18n="users.colDept">Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th class="p-4 text-right" data-i18n="users.colEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                    <th class="p-4 text-center" data-i18n="users.colStatus">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="p-4 text-center" data-i18n="users.colActions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700" id="usersTableBody">
                                <!-- Loading State -->
                                <tr>
                                    <td colspan="6" class="p-8 text-center">
                                        <div class="flex flex-col items-center gap-3 text-slate-400">
                                            <i class="fa-solid fa-spinner fa-spin text-3xl"></i>
                                            <p class="text-sm" data-i18n="users.loadingUsers">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View: Roles & Permissions -->
                <div id="view-roles" class="hidden flex-1 p-6 fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                        
                        <!-- Roles List -->
                        <div class="lg:col-span-4 lg:border-l border-slate-200 dark:border-slate-700 lg:pl-6 space-y-3 overflow-y-auto custom-scroll max-h-[550px]" id="rolesList">
                            <!-- Loading Placeholders -->
                            <div class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 animate-pulse">
                                <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                            </div>
                            <div class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 animate-pulse">
                                <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-slate-200 dark:bg-slate-700 rounded w-full"></div>
                            </div>
                        </div>
                        
                        <!-- Role Details & Permissions -->
                        <div class="lg:col-span-8">
                            <div class="bg-slate-50 dark:bg-slate-700/30 rounded-2xl p-6 border border-slate-200 dark:border-slate-600 h-full">
                                
                                <!-- Role Header -->
                                <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6 pb-4 border-b border-slate-200 dark:border-slate-600">
                                    <div>
                                        <h3 class="font-bold text-xl text-slate-800 dark:text-white mb-1" id="roleDetailName" data-i18n="users.selectRole">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
                                        <p class="text-sm text-slate-500 dark:text-slate-400" id="roleDetailDesc">--</p>
                                    </div>
                                    <span id="roleInheritsBadge" class="hidden px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-full text-xs font-bold whitespace-nowrap">
                                        <i class="fa-solid fa-link ml-1"></i>
                                        <span data-i18n="users.inheritsFrom">ÙŠØ±Ø« ØµÙ„Ø§Ø­ÙŠØ§Øª:</span>
                                        <span id="roleInheritsVal" class="font-bold"></span>
                                    </span>
                                </div>
                                
                                <!-- Permissions Grid -->
                                <div class="space-y-6 overflow-y-auto custom-scroll max-h-[400px] pr-2" id="permissionsContainer">
                                    <!-- Populated by JS -->
                                    <div class="text-center text-slate-400 py-8">
                                        <i class="fa-solid fa-shield-halved text-4xl mb-3"></i>
                                        <p class="text-sm" data-i18n="users.selectRoleToView">Ø§Ø®ØªØ± Ø¯ÙˆØ±Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="p-4 text-center text-xs text-slate-400 border-t border-slate-100 dark:border-slate-800">
            Â© 2026 Andromeda IT - AndroGov System v10.5
        </footer>
    </div>

    <!-- ===== SCRIPTS ===== -->
    
    <!-- 1. Data Layer -->
    <script src="data/company_policy.js"></script>
    
    <!-- 2. Core -->
    <script src="js/core/config.js"></script>
    <script src="js/core/i18n.js"></script>
    
    <!-- 3. Helpers -->
    <script src="js/helpers/policy-helpers.js"></script>
    
    <!-- 4. Services -->
    <script src="js/services/data-service.js"></script>
    
    <!-- 5. Components -->
    <script src="js/components/layout.js"></script>
    <script src="js/components/bot.js"></script>
    
    <!-- 6. Page Controller -->
    <script src="js/pages/users-page.js"></script>

    <!-- 7. Page Initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ Users page - DOM loaded');
            
            // âœ… Set initial language and direction
            const initialLang = localStorage.getItem('lang') || 'ar';
            document.documentElement.lang = initialLang;
            document.documentElement.dir = initialLang === 'ar' ? 'rtl' : 'ltr';
            
            // âœ… Set initial main content margin
            const mainContent = document.querySelector('.main-content-wrapper');
            if (mainContent) {
                if (initialLang === 'ar') {
                    mainContent.classList.remove('md:ml-72');
                    mainContent.classList.add('md:mr-72');
                } else {
                    mainContent.classList.remove('md:mr-72');
                    mainContent.classList.add('md:ml-72');
                }
            }
            
            // Wait for dependencies
            let attempts = 0;
            const maxAttempts = 50;
            
            const checkDependencies = setInterval(() => {
                attempts++;
                
                const hasLayout = typeof Layout !== 'undefined';
                const hasDataService = typeof DataService !== 'undefined';
                const hasAppConfig = typeof AppConfig !== 'undefined';
                const hasUsersPage = typeof UsersPage !== 'undefined';
                
                if (hasLayout && hasDataService && hasAppConfig && hasUsersPage) {
                    clearInterval(checkDependencies);
                    console.log('âœ… All dependencies loaded');
                    
                    // âœ… Auto-login if needed
                    if (!AppConfig.getCurrentUser()) {
                        console.log('âš ï¸ No user found. Auto-logging...');
                        const defaultUser = DataService.getUserById('USR_004') || DataService.getUsers()[0];
                        if (defaultUser) {
                            AppConfig.setCurrentUser(defaultUser);
                        }
                    }
                    
                    // âœ… Initialize Layout
                    Layout.init();
                    
                    // âœ… Initialize Page
                    setTimeout(() => {
                        try {
                            UsersPage.init();
                            hideLoading();
                            console.log('âœ… Users page initialized');
                        } catch (error) {
                            console.error('âŒ Error initializing:', error);
                            showErrorMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');
                        }
                    }, 300);
                    
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkDependencies);
                    console.error('âŒ Timeout: Dependencies not loaded');
                    showErrorMessage('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…');
                }
            }, 100);
            
            // âœ… Listen for language changes
            window.addEventListener('languageChanged', (e) => {
                console.log('ğŸŒ Language changed to:', e.detail.lang);
                
                // Update page content
                if (typeof window.updateUsersContent === 'function') {
                    window.updateUsersContent();
                }
                
                // Re-initialize page to update UI
                if (typeof UsersPage !== 'undefined' && UsersPage.init) {
                    UsersPage.init();
                }
            });
        });
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        
        function showErrorMessage(message) {
            hideLoading();
            
            const tbody = document.getElementById('usersTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-8 text-center">
                            <div class="flex flex-col items-center gap-3 text-red-500">
                                <i class="fa-solid fa-exclamation-triangle text-4xl"></i>
                                <p class="text-sm font-bold">${message}</p>
                                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-brandRed text-white rounded-lg text-sm font-bold hover:bg-red-700 transition">
                                    <i class="fa-solid fa-rotate-right ml-2"></i>
                                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„',
                    text: message,
                    confirmButtonText: 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„',
                    confirmButtonColor: '#FB4747'
                });
            }
        }
        
        // âœ… Expose content update function for Layout to call
        window.updateUsersContent = function() {
            const lang = localStorage.getItem('lang') || 'ar';
            
            // Update HTML attributes
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // Update main content margin
            const mainContent = document.querySelector('.main-content-wrapper');
            if (mainContent) {
                if (lang === 'ar') {
                    mainContent.classList.remove('md:ml-72');
                    mainContent.classList.add('md:mr-72');
                } else {
                    mainContent.classList.remove('md:mr-72');
                    mainContent.classList.add('md:ml-72');
                }
            }
            
            // Update page title
            const titles = {
                ar: 'AndroGov | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª',
                en: 'AndroGov | Users & Permissions Management'
            };
            document.title = titles[lang];
            
            console.log(`âœ… Users page content updated to: ${lang}`);
        };
    </script>

</body>
</html>
