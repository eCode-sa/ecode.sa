<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المكتبة الرقمية للسياسات | eGov System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">

    <style>
        /* تخطيط الصفحة */
        .policy-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: calc(100vh - 140px); }
        
        /* القائمة الجانبية */
        .policy-sidebar { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }
        .filters-area { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; gap: 5px; overflow-x: auto; }
        .filter-chip { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 5px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-chip.active, .filter-chip:hover { background: var(--lavender-dark); color: #fff; border-color: var(--lavender-dark); }
        .policy-list { flex: 1; overflow-y: auto; padding: 10px; }
        .policy-item { padding: 15px; border-radius: 10px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; margin-bottom: 5px; }
        .policy-item:hover { background: var(--bg-elevated); }
        .policy-item.active { background: rgba(139, 127, 255, 0.1); border-right: 3px solid var(--lavender-dark); }
        [dir="ltr"] .policy-item.active { border-right: none; border-left: 3px solid var(--lavender-dark); }
        .policy-item h4 { margin: 0 0 5px; font-size: 13px; color: var(--text-primary); line-height: 1.4; }
        .policy-item span { font-size: 10px; color: var(--text-muted); display: block; }

        /* منطقة القراءة */
        .policy-viewer { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }
        .viewer-toolbar { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
        .viewer-content { flex: 1; padding: 40px; overflow-y: auto; line-height: 1.8; font-size: 15px; color: var(--text-primary); white-space: pre-wrap; }
        
        /* تنسيق المحتوى الداخلي */
        .viewer-content h3 { color: var(--lavender-light); margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .viewer-content h4 { color: var(--sky-blue); margin-top: 20px; margin-bottom: 10px; }
        .viewer-content ul { padding-right: 20px; list-style-type: disc; color: var(--text-secondary); }
        [dir="ltr"] .viewer-content ul { padding-right: 0; padding-left: 20px; }
        .viewer-content li { margin-bottom: 8px; }
        
        .article-box { background: var(--bg-primary); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .article-title { color: var(--sky-blue); margin: 0 0 10px; font-size: 16px; font-weight: bold; }

        /* الطباعة */
        @media print {
            body * { visibility: hidden; }
            .policy-viewer, .viewer-content, .viewer-content * { visibility: visible; }
            .policy-viewer { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: #fff !important; color: #000 !important; border: none; }
            .viewer-toolbar { display: none; }
            .article-box { border: 1px solid #ddd; background: #fff; color: #000; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="Layout.toggleSidebar()"></div>

    <div class="app-container">
        <aside id="appSidebar" class="sidebar"></aside>
        <div class="main-content">
            <header id="appTopbar" class="topbar"></header>

            <main class="dashboard-content fade-in" id="workspace">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; color: var(--text-primary);" data-i18n="policies_title">المكتبة الرقمية للسياسات</h2>
                        <p style="margin: 5px 0 0; color: var(--text-secondary); font-size: 13px;" data-i18n="policies_desc">المرجع الموحد للوائح التنظيمية والإدارية.</p>
                    </div>
                </div>

                <div class="policy-layout">
                    <div class="policy-sidebar">
                        <div class="filters-area">
                            <div class="filter-chip active" onclick="filterList('All')" data-i18n="cat_all">الكل</div>
                            <div class="filter-chip" onclick="filterList('HR')" data-i18n="cat_hr">الموارد البشرية</div>
                            <div class="filter-chip" onclick="filterList('Finance')" data-i18n="cat_finance">المالية</div>
                            <div class="filter-chip" onclick="filterList('Governance')" data-i18n="cat_gov">الحوكمة</div>
                            <div class="filter-chip" onclick="filterList('IT')" data-i18n="cat_it">التقنية</div>
                        </div>
                        <div class="policy-list" id="policyListContainer"></div>
                    </div>

                    <div class="policy-viewer">
                        <div class="viewer-toolbar">
                            <div>
                                <h3 style="margin:0; font-size:18px;" id="viewTitle">...</h3>
                                <span style="font-size:12px; color:var(--text-secondary);" id="viewMeta">--</span>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button onclick="window.print()" style="background:var(--bg-elevated); color:var(--text-primary); border:1px solid var(--border-color); padding:8px 15px; border-radius:8px; cursor:pointer;">
                                    <i class="fas fa-print"></i> <span data-i18n="btn_print">طباعة</span>
                                </button>
                            </div>
                        </div>
                        <div class="viewer-content" id="viewContent">
                            <div style="text-align:center; margin-top:50px; color:var(--text-muted);">
                                <i class="fas fa-book-open" style="font-size:50px; margin-bottom:20px; opacity:0.3;"></i>
                                <p data-i18n="select_policy_hint">الرجاء اختيار لائحة من القائمة الجانبية.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="../assets/js/core/i18n.js"></script>
    <script src="../assets/js/layout.js"></script>
    <script src="../assets/js/components/bot.js"></script>

    <script src="../assets/js/data/company_data.js"></script>
    <script src="../assets/js/data/hr-policies.js"></script>
    <script src="../assets/js/data/financial-governance.js"></script>
    <script src="../assets/js/data/digital_governance.js"></script>
    <script src="../assets/js/data/governance.js"></script>
    <script src="../assets/js/data/assemblies_policies.js"></script>
    <script src="../assets/js/data/monitoring_mechanisms.js"></script>

    <script src="../assets/js/system.js"></script>

    <script>
        // --- 1. قاموس الترجمة ---
        const pageTranslations = {
            ar: {
                policies_title: "المكتبة الرقمية للسياسات", policies_desc: "المرجع الموحد للوائح التنظيمية والإدارية.",
                cat_all: "الكل", cat_hr: "الموارد البشرية", cat_finance: "المالية", cat_it: "التقنية", cat_gov: "الحوكمة",
                btn_print: "طباعة", lbl_version: "الإصدار", lbl_date: "تاريخ التحديث", select_policy_hint: "الرجاء اختيار لائحة من القائمة الجانبية."
            },
            en: {
                policies_title: "Policies Digital Library", policies_desc: "Unified reference for regulations.",
                cat_all: "All", cat_hr: "HR", cat_finance: "Finance", cat_it: "IT", cat_gov: "Governance",
                btn_print: "Print", lbl_version: "Version", lbl_date: "Last Updated", select_policy_hint: "Please select a policy from the sidebar."
            }
        };

        // --- 2. التحميل الأولي ---
        let allPolicies = [];
        let currentFilter = 'All';

        document.addEventListener('DOMContentLoaded', () => {
            // دمج الترجمة
            if(window.SYSTEM_TRANSLATIONS) {
                Object.assign(window.SYSTEM_TRANSLATIONS.ar, pageTranslations.ar);
                Object.assign(window.SYSTEM_TRANSLATIONS.en, pageTranslations.en);
                const lang = localStorage.getItem('eGov_Lang') || 'ar';
                if(window.updateLanguage) window.updateLanguage(lang);
            }

            // تحميل البيانات وعرضها
            loadAndProcessData();
            renderPolicyList('All');

            // ✅ استماع لتغيير اللغة لتحديث المحتوى فوراً
            window.addEventListener('languageChanged', () => {
                const lang = localStorage.getItem('eGov_Lang') || 'ar';
                loadAndProcessData(); // إعادة معالجة النصوص حسب اللغة الجديدة
                renderPolicyList(currentFilter); // إعادة رسم القائمة
                
                // تحديث المحتوى المعروض حالياً إذا كان هناك شيء مفتوح
                const activeItem = document.querySelector('.policy-item.active');
                if(activeItem) {
                    // نعيد تحميل نفس العنصر (نحتاج معرفته، لكن للتبسيط سنكتفي بتحديث القائمة)
                    document.getElementById('viewContent').innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-muted);"><p>${lang === 'ar' ? 'الرجاء اختيار اللائحة مجدداً لعرض الترجمة' : 'Please re-select the policy to view translation'}</p></div>`;
                }
            });
        });

        // --- 3. معالج البيانات الذكي (Smart Data Processor) ---
        function loadAndProcessData() {
            const lang = localStorage.getItem('eGov_Lang') || 'ar';
            allPolicies = []; // تصفير المصفوفة

            // 1. الموارد البشرية (HR)
            if (window.HR_POLICIES && window.HR_POLICIES.sections) {
                window.HR_POLICIES.sections.forEach(section => {
                    section.policies.forEach(policy => {
                        allPolicies.push({
                            id: policy.code,
                            cat: 'HR',
                            title: lang === 'ar' ? policy.title.ar : policy.title.en,
                            content: lang === 'ar' ? policy.content.ar : policy.content.en
                        });
                    });
                });
            }

            // 2. المالية (Finance)
            if (window.FINANCIAL_GOVERNANCE && window.FINANCIAL_GOVERNANCE.sections) {
                window.FINANCIAL_GOVERNANCE.sections.forEach(section => {
                    section.policies.forEach(policy => {
                        allPolicies.push({
                            id: policy.code,
                            cat: 'Finance',
                            title: lang === 'ar' ? policy.title.ar : policy.title.en,
                            content: lang === 'ar' ? policy.content.ar : policy.content.en
                        });
                    });
                });
            }

            // 3. الجمعيات العمومية (Governance)
            if (window.egovassembliespolicies) {
                window.egovassembliespolicies.forEach(item => {
                    allPolicies.push({
                        id: item.id,
                        cat: 'Governance',
                        title: lang === 'ar' ? item.title.ar : item.title.en,
                        content: lang === 'ar' ? item.content.ar : item.content.en
                    });
                });
            }

            // 4. الحوكمة العامة (Governance)
            if (window.governanceTexts) {
                window.governanceTexts.forEach(item => {
                    allPolicies.push({
                        id: item.id,
                        cat: 'Governance',
                        title: lang === 'ar' ? item.title.ar : item.title.en,
                        content: lang === 'ar' ? item.content.ar : item.content.en
                    });
                });
            }

            // 5. ✅ الحوكمة الرقمية (IT) - تم الإصلاح لعرض كامل المحتوى
            if (window.egovDigitalGovernance) {
                const dg = window.egovDigitalGovernance[lang]; 
                if (dg) {
                    // تجميع كل الأقسام في نص واحد HTML
                    let html = `<p><strong>${dg.intro}</strong></p>`;
                    
                    // الأهمية
                    html += `<h3>${dg.importance_title}</h3><ul>`;
                    dg.importance_items.forEach(item => html += `<li>${item}</li>`);
                    html += `</ul>`;

                    // الأدوار (Roles)
                    if (dg.roles) {
                        html += `<h3>${dg.roles.ciso_title}</h3><p>${dg.roles.ciso_intro}</p><ul>`;
                        dg.roles.ciso_responsibilities.forEach(r => html += `<li>${r}</li>`);
                        html += `</ul>`;
                        
                        html += `<h3>${dg.roles.management_title}</h3><ul>`;
                        dg.roles.management_responsibilities.forEach(r => html += `<li>${r}</li>`);
                        html += `</ul>`;
                    }

                    // جمع البيانات (Data Collection)
                    if (dg.employee_data) {
                        html += `<h3>${dg.employee_data.title}</h3><p>${dg.employee_data.intro}</p>`;
                        dg.employee_data.categories.forEach(cat => {
                            html += `<h4>${cat.label}</h4><ul>`;
                            cat.reasons.forEach(r => html += `<li>${r}</li>`);
                            html += `</ul>`;
                        });
                    }

                    // العقوبات (Sanctions)
                    if (dg.security_sanctions) {
                        html += `<h3>${dg.security_sanctions.title}</h3><p>${dg.security_sanctions.intro}</p><ul>`;
                        dg.security_sanctions.sanctions.forEach(s => html += `<li>${s}</li>`);
                        html += `</ul>`;
                    }

                    allPolicies.push({
                        id: 'digital_gov_full',
                        cat: 'IT',
                        title: dg.title,
                        content: html
                    });
                }
            }

            // 6. آليات المراقبة (Governance)
            if (window.egovMonitoringMechanisms) {
                const mm = window.egovMonitoringMechanisms[lang];
                if (mm) {
                    let html = `<p>${mm.intro}</p>`;
                    
                    // Internal Audit
                    html += `<h3>${mm.internal_audit.title}</h3><p>${mm.internal_audit.role}</p><ul>`;
                    mm.internal_audit.types.forEach(t => html += `<li>${t}</li>`);
                    html += `</ul>`;

                    // External Audit
                    html += `<h3>${mm.external_audit.title}</h3><p>${mm.external_audit.role}</p>`;

                    // Whistleblowing
                    html += `<h3>${mm.whistleblowing.title}</h3><p>${mm.whistleblowing.channels}</p>`;

                    allPolicies.push({
                        id: 'monitoring_full',
                        cat: 'Governance',
                        title: mm.title,
                        content: html
                    });
                }
            }
        }

        // --- 4. العرض والفلترة ---
        function renderPolicyList(filter) {
            currentFilter = filter;
            const container = document.getElementById('policyListContainer');
            const lang = localStorage.getItem('eGov_Lang') || 'ar';
            
            container.innerHTML = '';

            const filtered = allPolicies.filter(p => filter === 'All' || p.cat === filter);

            if(filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">لا توجد بيانات</p>';
                return;
            }

            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = 'policy-item';
                div.onclick = () => loadPolicy(p, div);
                div.innerHTML = `
                    <h4>${p.title}</h4>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--sky-blue)">${p.cat}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterList(cat) {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            renderPolicyList(cat);
        }

        function loadPolicy(policy, element) {
            document.querySelectorAll('.policy-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('viewTitle').innerText = policy.title;
            const lang = localStorage.getItem('eGov_Lang') || 'ar';
            document.getElementById('viewMeta').innerText = lang === 'ar' ? `التصنيف: ${policy.cat}` : `Category: ${policy.cat}`;
            document.getElementById('viewContent').innerHTML = policy.content;
        }
    </script>

</body>
</html>
