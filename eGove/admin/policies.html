<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المكتبة الرقمية للسياسات | eGov System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">

    <style>
        /* تخطيط الصفحة */
        .policy-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: calc(100vh - 140px); }
        
        /* القائمة الجانبية */
        .policy-sidebar { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }
        .filters-area { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; gap: 5px; overflow-x: auto; }
        .filter-chip { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 5px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-chip.active, .filter-chip:hover { background: var(--lavender-dark); color: #fff; border-color: var(--lavender-dark); }
        .policy-list { flex: 1; overflow-y: auto; padding: 10px; }
        .policy-item { padding: 15px; border-radius: 10px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; margin-bottom: 5px; }
        .policy-item:hover { background: var(--bg-elevated); }
        .policy-item.active { background: rgba(139, 127, 255, 0.1); border-right: 3px solid var(--lavender-dark); }
        .policy-item h4 { margin: 0 0 5px; font-size: 13px; color: var(--text-primary); line-height: 1.4; }
        .policy-item span { font-size: 10px; color: var(--text-muted); display: block; }

        /* منطقة القراءة */
        .policy-viewer { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; }
        .viewer-toolbar { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); }
        .viewer-content { flex: 1; padding: 40px; overflow-y: auto; line-height: 1.8; font-size: 15px; color: var(--text-primary); white-space: pre-wrap; }
        
        /* تنسيق المحتوى */
        .content-header { color: var(--lavender-light); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .list-point { margin-bottom: 10px; padding-right: 20px; position: relative; }
        .list-point::before { content: '•'; position: absolute; right: 0; color: var(--sky-blue); }

        /* الطباعة */
        @media print {
            body * { visibility: hidden; }
            .policy-viewer, .viewer-content, .viewer-content * { visibility: visible; }
            .policy-viewer { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: #fff !important; color: #000 !important; border: none; }
            .viewer-toolbar { display: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="Layout.toggleSidebar()"></div>

    <div class="app-container">
        <aside id="appSidebar" class="sidebar"></aside>
        <div class="main-content">
            <header id="appTopbar" class="topbar"></header>

            <main class="dashboard-content fade-in" id="workspace">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; color: var(--text-primary);">المكتبة الرقمية للسياسات</h2>
                        <p style="margin: 5px 0 0; color: var(--text-secondary); font-size: 13px;">المرجع الموحد للوائح التنظيمية والإدارية.</p>
                    </div>
                </div>

                <div class="policy-layout">
                    <div class="policy-sidebar">
                        <div class="filters-area">
                            <div class="filter-chip active" onclick="filterList('All')">الكل</div>
                            <div class="filter-chip" onclick="filterList('HR')">الموارد البشرية</div>
                            <div class="filter-chip" onclick="filterList('Finance')">المالية</div>
                            <div class="filter-chip" onclick="filterList('Governance')">الحوكمة</div>
                            <div class="filter-chip" onclick="filterList('IT')">التقنية</div>
                        </div>
                        <div class="policy-list" id="policyListContainer"></div>
                    </div>

                    <div class="policy-viewer">
                        <div class="viewer-toolbar">
                            <div>
                                <h3 style="margin:0; font-size:18px;" id="viewTitle">اختر لائحة للعرض</h3>
                                <span style="font-size:12px; color:var(--text-secondary);" id="viewMeta">--</span>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button onclick="window.print()" style="background:var(--bg-elevated); color:var(--text-primary); border:1px solid var(--border-color); padding:8px 15px; border-radius:8px; cursor:pointer;">
                                    <i class="fas fa-print"></i> طباعة
                                </button>
                            </div>
                        </div>
                        <div class="viewer-content" id="viewContent">
                            <div style="text-align:center; margin-top:50px; color:var(--text-muted);">
                                <i class="fas fa-book-open" style="font-size:50px; margin-bottom:20px; opacity:0.3;"></i>
                                <p>الرجاء اختيار لائحة من القائمة الجانبية.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="../assets/js/core/i18n.js"></script>
    <script src="../assets/js/layout.js"></script>
    <script src="../assets/js/components/bot.js"></script>

    <script src="../assets/js/data/company_data.js"></script>
    <script src="../assets/js/data/hr-policies.js"></script>
    <script src="../assets/js/data/financial-governance.js"></script>
    <script src="../assets/js/data/digital_governance.js"></script>
    <script src="../assets/js/data/governance.js"></script> <script src="../assets/js/data/assemblies_policies.js"></script>
    <script src="../assets/js/data/monitoring_mechanisms.js"></script>

    <script src="../assets/js/system.js"></script>

    <script>
        // --- مجمع البيانات الذكي (Data Aggregator) ---
        let allPolicies = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadAndProcessData();
            renderPolicyList('All');
        });

        function loadAndProcessData() {
            const lang = localStorage.getItem('eGov_Lang') || 'ar';

            // 1. معالجة سياسات الموارد البشرية (HR)
            if (window.HR_POLICIES && window.HR_POLICIES.sections) {
                window.HR_POLICIES.sections.forEach(section => {
                    section.policies.forEach(policy => {
                        allPolicies.push({
                            id: policy.code,
                            cat: 'HR',
                            title: lang === 'ar' ? policy.title.ar : policy.title.en,
                            content: lang === 'ar' ? policy.content.ar : policy.content.en
                        });
                    });
                });
            }

            // 2. معالجة الحوكمة المالية (Finance)
            if (window.FINANCIAL_GOVERNANCE && window.FINANCIAL_GOVERNANCE.sections) {
                window.FINANCIAL_GOVERNANCE.sections.forEach(section => {
                    section.policies.forEach(policy => {
                        allPolicies.push({
                            id: policy.code,
                            cat: 'Finance',
                            title: lang === 'ar' ? policy.title.ar : policy.title.en,
                            content: lang === 'ar' ? policy.content.ar : policy.content.en
                        });
                    });
                });
            }

            // 3. معالجة الجمعيات العمومية (Governance)
            if (window.egovassembliespolicies) {
                window.egovassembliespolicies.forEach(item => {
                    allPolicies.push({
                        id: item.id,
                        cat: 'Governance',
                        title: lang === 'ar' ? item.title.ar : item.title.en,
                        content: lang === 'ar' ? item.content.ar : item.content.en
                    });
                });
            }

            // 4. معالجة الحوكمة العامة (Governance)
            if (window.governanceTexts) {
                window.governanceTexts.forEach(item => {
                    allPolicies.push({
                        id: item.id,
                        cat: 'Governance',
                        title: lang === 'ar' ? item.title.ar : item.title.en,
                        content: lang === 'ar' ? item.content.ar : item.content.en
                    });
                });
            }

            // 5. معالجة الحوكمة الرقمية (IT) - هيكل خاص
            if (window.egovDigitalGovernance) {
                const dg = window.egovDigitalGovernance[lang]; // ar or en
                if (dg) {
                    let htmlContent = `<p>${dg.intro}</p><h3>${dg.importance_title}</h3><ul>`;
                    dg.importance_items.forEach(point => {
                        htmlContent += `<li>${point}</li>`;
                    });
                    htmlContent += `</ul>`;

                    allPolicies.push({
                        id: 'digital_gov_main',
                        cat: 'IT',
                        title: dg.title,
                        content: htmlContent
                    });
                }
            }

            // 6. معالجة آليات المراقبة (Governance) - هيكل معقد
            if (window.egovMonitoringMechanisms) {
                const mm = window.egovMonitoringMechanisms[lang];
                if (mm) {
                    // تحويل الكائن المعقد إلى نص HTML مقروء
                    let htmlContent = `<p>${mm.intro}</p>`;
                    
                    // Internal Audit
                    htmlContent += `<h3>${mm.internal_audit.title}</h3><p>${mm.internal_audit.role}</p>`;
                    htmlContent += `<ul>${mm.internal_audit.objectives.map(o => `<li>${o}</li>`).join('')}</ul>`;
                    
                    // External Audit
                    htmlContent += `<h3>${mm.external_audit.title}</h3><p>${mm.external_audit.role}</p>`;
                    
                    // Whistleblowing
                    htmlContent += `<h3>${mm.whistleblowing.title}</h3><p>${mm.whistleblowing.channels}</p>`;

                    allPolicies.push({
                        id: 'monitoring_mechanisms',
                        cat: 'Governance',
                        title: mm.title,
                        content: htmlContent
                    });
                }
            }
        }

        // --- دوال العرض ---
        function renderPolicyList(filter) {
            const container = document.getElementById('policyListContainer');
            container.innerHTML = '';

            const filtered = allPolicies.filter(p => filter === 'All' || p.cat === filter);

            if(filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">لا توجد بيانات</p>';
                return;
            }

            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = 'policy-item';
                div.onclick = () => loadPolicy(p, div);
                div.innerHTML = `
                    <h4>${p.title}</h4>
                    <div style="display:flex; justify-content:space-between;">
                        <span>${p.cat}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterList(cat) {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            renderPolicyList(cat);
        }

        function loadPolicy(policy, element) {
            document.querySelectorAll('.policy-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('viewTitle').innerText = policy.title;
            document.getElementById('viewMeta').innerText = `التصنيف: ${policy.cat}`;
            document.getElementById('viewContent').innerHTML = policy.content;
        }
    </script>

</body>
</html>
